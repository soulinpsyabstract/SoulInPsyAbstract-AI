name: NodeJS with Webpack

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Diagnostics â€” environment
        run: |
          set -x
          echo "USER: $(whoami)"
          echo "PWD: $(pwd)"
          echo "GIT SHA: $(git rev-parse --short HEAD)"
          node --version
          npm --version
          env | sort

      - name: Install dependencies (verbose)
        run: |
          set -o pipefail
          # Use npm ci for clean, reproducible install
          npm ci --prefer-offline --no-audit --progress=false 2>&1 | tee ci-install.log
          ls -la
          echo "=== install log (first 200 lines) ==="
          sed -n '1,200p' ci-install.log

      - name: Build (capture exit code and logs)
        run: |
          set -o pipefail
          # If you have a "build" script in package.json, prefer `npm run build`.
          # Otherwise this will run webpack directly.
          if npm run | grep -q ' build'; then
            echo "Running: npm run build"
            npm run build --loglevel verbose 2>&1 | tee build.log || true
            rc=${PIPESTATUS[0]}
          else
            echo "Running: npx webpack"
            npx webpack --progress --color 2>&1 | tee build.log || true
            rc=${PIPESTATUS[0]}
          fi
          echo "BUILD_EXIT_CODE=$rc" > build-exit.txt
          echo "=== build log (last 200 lines) ==="
          tail -n 200 build.log || true
          cat build-exit.txt
          if [ "$rc" -ne 0 ]; then
            echo "Build failed with exit code $rc"
            exit $rc
          fi
